# Deploy KRaft-based setup with mtls and auto-generated certs


- [Set the current tutorial directory](#set-the-current-tutorial-directory)
- [Deploy Confluent for Kubernetes](#deploy-confluent-for-kubernetes)
- [Provide a Certificate Authority](#provide-a-certificate-authority)
- [Set up cluster](#set-up-cluster)
- [Tear down Cluster](#tear-down-cluster)

This playbook explains how to deploy KRaft based setup with mtls and auto-generated certs

Before continuing with the scenario, ensure that you have set up the
[prerequisites](/README.md#prerequisites).


## Set the current tutorial directory

Set the tutorial directory under the directory you downloaded this Github repo:

```   
export TUTORIAL_HOME=<Github repo directory>/security/kraft-mtls-autogenerated
```

## Deploy Confluent for Kubernetes

This workflow scenario assumes you are using the namespace `confluent`.

Set up the Helm Chart:

```
helm repo add confluentinc https://packages.confluent.io/helm
```

Install Confluent For Kubernetes using Helm:

```
helm upgrade --install confluent-operator confluentinc/confluent-for-kubernetes -n confluent 
```

Check that the Confluent For Kubernetes pod comes up and is running:

```
kubectl get pods -n confluent
```


## Provide a Certificate Authority

Confluent For Kubernetes provides auto-generated certificates for Confluent Platform
components to use for TLS network encryption. A CA is needed to achieve this.

Generate a CA pair to use:

```
openssl genrsa -out $TUTORIAL_HOME/ca/ca-key.pem 2048

openssl req -new -key $TUTORIAL_HOME/ca/ca-key.pem -x509 \
  -days 1000 \
  -out $TUTORIAL_HOME/ca/ca.pem \
  -subj "/C=US/ST=CA/L=MountainView/O=Confluent/OU=Operator/CN=TestCA"
```

Create the the K8s secret

```
kubectl create secret tls ca-pair-sslcerts \
  --cert=$TUTORIAL_HOME/ca/ca.pem \
  --key=$TUTORIAL_HOME/ca/ca-key.pem -n confluent
```

## Set up cluster

### Deploy CP
```
kubectl apply -f $TUTORIAL_HOME/confluent-platform-mtls.yml -n confluent
```

## Tear down

```
kubectl delete -f $TUTORIAL_HOME/confluent-platform-mtls.yml -n confluent
```
